# Voice Configuration - IORS Speech & Conversation Settings
#
# Konfiguracja pipeline'u glosowego.
# Primary: ConversationRelay (Deepgram STT + ElevenLabs TTS + WebSocket)
# Fallback: Twilio Gather (HTTP turn-by-turn)
# Web: Web Speech API (browser-native)

# =====================================================
# TRANSPORT
# =====================================================

transport:
  # Primary: ConversationRelay (real-time WebSocket)
  # Set VOICE_WS_URL env to enable. Unset = legacy Gather mode.
  primary: "conversation_relay"
  fallback: "gather"
  ws_server:
    env_key: "VOICE_WS_URL"
    port_env: "VOICE_WS_PORT"
    default_port: 8080
    notes: "Deploy on Railway/Render. Run: npx tsx server/voice-ws.ts"

# =====================================================
# PROVIDERS
# =====================================================

providers:
  telephony:
    name: "Twilio"
    env_keys:
      account_sid: "TWILIO_ACCOUNT_SID"
      auth_token: "TWILIO_AUTH_TOKEN"
    phone_numbers:
      primary: "+48732143210"

  stt:
    # ConversationRelay mode: Deepgram Nova (streaming, best Polish)
    conversation_relay:
      name: "Deepgram Nova"
      provider_key: "Deepgram"
      language: "pl"
      hints: "ExoSkull,IORS,Bogumił"
      notes: "Configured via ConversationRelay TwiML. No API key needed (Twilio manages it)."
    # Legacy Gather mode: Twilio built-in
    gather:
      name: "Twilio Gather"
      language: "pl-PL"
      notes: "Twilio built-in STT via <Gather>"
    # Web browser
    web:
      name: "Web Speech API"
      language: "pl-PL"
      notes: "Browser-native, free, no API key needed"

  tts:
    # ConversationRelay mode: ElevenLabs (natural Polish, managed by Twilio)
    conversation_relay:
      name: "ElevenLabs"
      provider_key: "ElevenLabs"
      env_key: "ELEVENLABS_VOICE_ID"
      notes: "Configured via ConversationRelay TwiML. Voice ID in env."
    # Legacy Gather mode: Cartesia Sonic 3 (server-side generation)
    gather:
      name: "Cartesia Sonic 3"
      model: "sonic-3"
      env_key: "CARTESIA_API_KEY"
      voice_id_env: "CARTESIA_VOICE_ID"
      default_voice: "82a7fc13-2927-4e42-9b8a-bb1f9e506521"
      notes: "5x cheaper than ElevenLabs. Used when ConversationRelay unavailable."

  llm:
    name: "Claude"
    model: "claude-sonnet-4-20250514"
    env_key: "ANTHROPIC_API_KEY"
    max_tokens: 200
    notes: "Fast + capable for voice. Shared between both transport modes."

# =====================================================
# IORS IDENTITY
# =====================================================

identity:
  default_name: "IORS"
  full_name: "Intelligent Observant Reinforcement System"
  db_column: "assistant_name"
  notes: "User can customize via settings. Reads from exo_tenants.assistant_name"

# =====================================================
# LANGUAGE & LOCALE
# =====================================================

language:
  primary: "pl"
  fallback: "en"
  detect_language: false

locale:
  timezone: "Europe/Warsaw"
  date_format: "DD.MM.YYYY"
  time_format: "HH:mm"

# =====================================================
# CONVERSATION SETTINGS
# =====================================================

conversation:
  max_turns: 50
  silence_timeout_ms: 30000
  max_duration_minutes: 30

  greeting:
    morning: "Czesc {name}. Jak sie czujesz?"
    afternoon: "Czesc {name}. Co slychac?"
    evening: "Czesc {name}. Jak minal dzien?"
    night: "Czesc {name}. Powinnas juz spac!"

  goodbye:
    - "Do uslyszenia!"
    - "Na razie!"
    - "Trzymaj sie!"

# =====================================================
# PERFORMANCE TARGETS
# =====================================================

performance:
  # ConversationRelay targets (significantly faster)
  conversation_relay:
    stt_latency_target_ms: 300
    llm_response_target_ms: 1500
    tts_start_target_ms: 200
    total_turnaround_target_ms: 1500
    p50_target_ms: 491
  # Legacy Gather targets
  gather:
    stt_latency_target_ms: 500
    llm_response_target_ms: 2000
    tts_generation_target_ms: 1000
    total_turnaround_target_ms: 3500

# =====================================================
# AUDIO CACHING (Legacy Gather mode only)
# =====================================================
# ConversationRelay handles TTS directly — no caching needed on our side.

audio_cache:
  enabled: true
  storage: "supabase"
  bucket: "voice-audio"
  ttl_days: 30
  notes: "Only used in legacy Gather mode. ConversationRelay bypasses this."

  cached_phrases:
    - "Cześć! Tu IORS. W czym mogę pomóc?"
    - "Tak, rozumiem."
    - "Moment, sprawdzam."
    - "Zrobione."
    - "Nie zrozumiałem. Powtórz?"
    - "Coś jeszcze?"
    - "Do usłyszenia!"
    - "Czekaj chwilę."
    - "Przepraszam, wystąpił błąd."
    - "Dodałem zadanie."
    - "Sprawdzam kalendarz."
    - "Wysyłam wiadomość."
    - "Notatka zapisana."
    - "Potrzebuję więcej informacji."
    - "Potwierdzam."
    - "Miłego dnia!"

# =====================================================
# CONVERSATION RELAY CONFIG
# =====================================================

conversation_relay:
  interruptible: true
  dtmf_detection: true
  interrupt_sensitivity: "high"
  hints: "ExoSkull,IORS,Bogumił"
  elevenlabs_text_normalization: "auto"

# =====================================================
# PROMPT CONFIGURATION
# =====================================================

prompts:
  system_prompt_file: "lib/voice/system-prompt.ts"
  personality_file: "lib/voice/PSYCODE.md"

  context_injection:
    user_profile: true
    recent_conversations: 5
    active_tasks: true
    calendar_today: true
    health_data: true

# =====================================================
# CALL HANDLING
# =====================================================

calls:
  inbound:
    auto_answer: true
    greeting_delay_ms: 500
    unknown_number_handling: "ask_name"

  outbound:
    retry_on_no_answer: 1
    retry_delay_minutes: 30
    fallback_to_sms: true

  recording:
    enabled: false
    retention_days: 90

# =====================================================
# ERROR HANDLING
# =====================================================

errors:
  max_consecutive_failures: 3
  on_stt_fail: "Przepraszam, nie zrozumiałem. Powtórz?"
  on_llm_fail: "Przepraszam, coś poszło nie tak. Spróbujmy jeszcze raz."
  on_tts_fail: "fallback_to_native"

  circuit_breaker:
    threshold: 5
    cooldown_seconds: 300

# =====================================================
# SCHEDULED CALLS
# =====================================================

scheduled:
  morning_checkin:
    default_time: "07:00"
    channel: "voice"
    prompt_file: "hardprompts/daily-summary.md"

  evening_reflection:
    default_time: "21:00"
    channel: "sms"
    prompt_file: "hardprompts/daily-summary.md"

# =====================================================
# QUIET HOURS
# =====================================================

quiet_hours:
  enabled: true
  start: "22:00"
  end: "07:00"
  exceptions:
    - "emergency"
    - "crisis_detection"
