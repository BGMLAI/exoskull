# ExoSkull Changelog

## 2026-02-28 — Fix: Agent Amnesia & Apologetic Behavior

### Fix: Agent stops "forgetting" and apologizing
- **Root cause 1:** Empty memory search injected disclaimer "Brak bezpośrednio pasujących wspomnień" into system prompt → agent read it and told user "nie pamiętam"
- **Fix:** Removed disclaimer injection. Empty memory = no comment (agent uses thread context instead).
- **Root cause 2:** Error handler hardcoded "Przepraszam, wystąpił błąd" — directly violating system prompt rule "NIGDY nie przepraszaj"
- **Fix:** Replaced with neutral "Błąd przetwarzania. Spróbuj ponownie." and "Timeout — spróbuj ponownie."
- **Root cause 3:** Emergency Gemini fallback sliced system prompt to 8000 chars → lost personality, tools-first rules, and anti-apology instructions
- **Fix:** Increased to 64000 chars (Gemini 2.5 Flash supports 1M context).
- **Root cause 4:** Knowledge pre-fetch failures logged at DEBUG level → invisible in production
- **Fix:** Upgraded to WARN level for visibility.

### Files Changed
| File | Action |
|------|--------|
| `lib/agent-sdk/exoskull-agent.ts` | MODIFIED — removed memory disclaimer, fixed error messages, increased Gemini prompt limit |
| `app/api/chat/stream/route.ts` | MODIFIED — knowledge pre-fetch failure now WARN level |

---

## 2026-02-28 — Strategy→Task Pipeline + DeepSeek V3

### Fix: Strategy→Task Execution Pipeline
- **Root cause:** Strategies generated by AI stayed "proposed" forever — `approveStrategy()` existed but was never called from any automated or chat path.
- **Fix 1: Auto-activation** — Strategies with confidence ≥ 0.7 now auto-approve via `approveStrategy()` in `strategy-engine.ts`.
- **Fix 2: `isStrategyStuck()`** — Was querying nonexistent `exo_goal_strategy_steps` table. Now reads JSONB steps from `exo_goal_strategies.steps` via `getActiveStrategy()`.
- **Fix 3: goal_id in task context** — All tasks created by strategy execution now include `context.goal_id`, enabling the feedback loop (`onTaskCompleted()` → `updateStrategyStepFromTask()`).
- **Fix 4: 3 IORS tools** — `view_goal_strategies`, `approve_goal_strategy`, `pause_goal_strategy` — chat-based strategy management.

### Feature: DeepSeek V3 as Primary Tier 1+2 Model
- **Why:** Gemini API limits exhausted, cannot be increased.
- **Provider:** OpenAI-compatible API at `https://api.deepseek.com`, model `deepseek-chat`.
- **Cost:** $0.27/1M input, $1.10/1M output (cheaper than Gemini).
- **Routing:** DeepSeek first in Tier 1 and Tier 2 arrays, Gemini as fallback.
- **Files:** `deepseek-provider.ts` (new), `types.ts`, `config.ts`, `model-router.ts`, `providers/index.ts`.

### Files Changed
| File | Action |
|------|--------|
| `exoskull-app/lib/goals/goal-orchestrator.ts` | MODIFIED — fixed isStrategyStuck() |
| `exoskull-app/lib/goals/strategy-engine.ts` | MODIFIED — auto-activate + goal_id in context |
| `exoskull-app/lib/iors/tools/goal-strategy-tools.ts` | NEW — 3 IORS tools |
| `exoskull-app/lib/iors/tools/index.ts` | MODIFIED — registered goal strategy tools |
| `exoskull-app/lib/ai/providers/deepseek-provider.ts` | NEW — DeepSeek V3 provider |
| `exoskull-app/lib/ai/types.ts` | MODIFIED — added deepseek types |
| `exoskull-app/lib/ai/config.ts` | MODIFIED — DeepSeek config + tier routing |
| `exoskull-app/lib/ai/model-router.ts` | MODIFIED — register DeepSeek provider |
| `exoskull-app/lib/ai/providers/index.ts` | MODIFIED — export DeepSeekProvider |

## 2026-02-24 — P1 Event Dedup + VPS Knowledge Access

### Fix: P1 Event Spam (Petla dedup)
- **Root cause:** Dedup unique index only covered `status = 'pending'`. Once events transitioned to `claimed`/`dispatched`, same `dedup_key` could be reinserted, causing Petla CRON (1/min) to process duplicates.
- **Fix:** Broadened unique index to cover `pending + claimed + dispatched`. Only `ignored` allows re-emission.
- **Migration:** `supabase/migrations/20260224000001_fix_petla_dedup_index.sql`
- **Cleanup:** Existing duplicate dispatched events marked as `ignored`.

### Feature: VPS Knowledge Access (Phase 1 + Phase 2)
- **Phase 1:** Chat stream pre-fetches top 3 knowledge results before VPS proxy, prepends `[KNOWLEDGE CONTEXT]` block. Non-blocking try/catch.
- **Phase 2a:** Internal API endpoints (`/api/internal/knowledge-search`, `/api/internal/knowledge-documents`) with `VPS_AGENT_SECRET` auth.
- **Phase 2b:** VPS agent-executor gains `search_knowledge` and `list_documents` tools. Calls back to Vercel internal endpoints.
- **Middleware:** `/api/internal/` added to public bypass list.
- **Docker:** `EXOSKULL_API_URL` env var added to `docker-compose.yml`.

### Files Changed
| File | Action |
|------|--------|
| `supabase/migrations/20260224000001_fix_petla_dedup_index.sql` | NEW |
| `exoskull-app/app/api/chat/stream/route.ts` | MODIFIED |
| `exoskull-app/app/api/internal/knowledge-search/route.ts` | NEW |
| `exoskull-app/app/api/internal/knowledge-documents/route.ts` | NEW |
| `exoskull-app/lib/supabase/middleware.ts` | MODIFIED |
| `vps-executor/src/services/agent-executor.ts` | MODIFIED |
| `vps-executor/docker-compose.yml` | MODIFIED |

## 2026-02-23 — Architecture Fixes + Auth + E2E Testing

See git log for details.
